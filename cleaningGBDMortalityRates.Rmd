---
title: "Cleaning Mortality Rates File"
author: "Aarsh"
date: '2022-09-28'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Global parameters and libraries
```{r lib_glob_parameters}

# libraries
library(readr)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)

# load and document (for automatic rendering of the roxygen comments into a man file) to keep things updated
devtools::load_all()
devtools::document()

# custom operators
`%notin%` <- Negate(`%in%`)

# global parameters 
gbd_year <- 2019

```

## Cleaning the Mortality Rates file: Main Steps

* Load in the Mortality Rates raw csv file for `r gbd_year` as per the instructions in the **CodeOutlineREADME.docx** file, present at the root of this repo.
* Drop certain countries **(Why?)**: England, Wales, Northern Ireland, Scotland.
* Rename certain columns in the files (and label variables)
  * val > mortal_rate
  * sex_name > sex, 
  * cause_name > cause

* Drop certain rows:
  * **(Why?)**Where Age intervals is one of: All Ages, Age Standardized, Neonatal, [5, 14], [15, 49], [50, 69], [70, inf], [80, inf], [10, 24], [10, 54], [10, 19]. It looks like that from one year to the next, the `age_ids` to `age_name` mapping remains the same in GBD. But, still check this in the GBD dataset that you are using. If the mapping has changed, just make sure that you drop those `age_ids` that correspond to the following `age_names` listed earlier in this point.
* Drop all rows with cause == "All causes"
* Replace `age_name` column's following age_names: "Under 5" (age id: 1), "<1" (age_id: 235), "<20" (age id: 158) with: "0-5", "0-1", "0-20" respectively
* remove the word "years" from the "age_name" column
* Add an `age_interval_lower` column, which would be the lower limit of the `age_name` column.
* Replace `age_interval_lower` "95 plus years" value with "95" and "80+ years" value with 80.

```{r cleanMortalityRatesRawFile}
#> reading in the raw .csv file for mortality rates dataset from GBD for the year mentioned uptop in the "lib_glob_parameters" code chunk
mr_dataset_2019_raw <- read_csv("./data/raw/ihme_gbd_2019_mortality_rates_by_cause.csv")

#> drop certain columns and rename others to make them more intuitive

# rename "cause_name" and "val" columns, arrange by (cause, age_id) and keep the following columns: age_id, age_name, cause_name, val.
mr_dataset_2019 <- mr_dataset_2019_raw %>%
    rename(cause = cause_name, 
         mortal_rate = val, 
         sex = sex_name) %>%
  select(age_id, age_name, cause, mortal_rate) %>%
  arrange(cause, age_id) 

#> Replace `age_name` column's following age_names with the specified counterparts: "<1" (age_id: 235) with "0-1"
mr_dataset_2019 <- mr_dataset_2019 %>%
  mutate(age_name = str_replace(age_name,  "<1 year", "0-1")) %>%
  arrange(cause)

#> remove the "years" keyword from the age_name column and "+" from "95+"
mr_dataset_2019$age_name <- str_replace(mr_dataset_2019$age_name, "years", "")

#> Add an `age_interval_lower` and age_interval upper column, which would be the lower limit and upper limit of the `age_name` column and remove the "+" sign from the "age_name" column
mr_dataset_2019 <- mr_dataset_2019 %>%
  mutate(age_name_ll = ifelse(str_detect(age_name, "\\+") == TRUE, str_replace(age_name, "\\+", "") , str_extract(age_name, "(.)+(-)")), 
         age_name_ll = str_replace(age_name_ll, "(\\+)|(-)", ""),
         age_name_ul = ifelse(str_detect(age_name, "\\+") == TRUE, str_replace(age_name, "\\+", "") , str_extract(age_name, "(-)(.)+")), 
         age_name_ul = str_replace(age_name_ul, "(\\+)|(-)", ""), 
          age_name = str_replace(age_name, "(\\+)", ""))

#> renaming columns so that we are consistent with the "relative risks" dataset column names. Ultimately th "relative risks" data will be merged with the "mortality rates" dataset. Consistent column names will make the merging code more intuitive. Also, dropping the "age_id" column which is standalone column in the mortality rates datset and does not have a counterpart in the relative risks dataset (so basically is of no use to us).

mr_dataset_2019 <- mr_dataset_2019 %>%
  rename(mortality_rate = mortal_rate, 
         age_interval_ll = age_name_ll,
         age_interval_ul = age_name_ul, 
         age_interval = age_name) %>%
  select(-c(age_id))

#> Writing the cleaned GBD mortality rates file to the data/intermediate folder
mr_dataset_2019 %>%
  write_csv("data/intermediate/cleaned_gbd_mortality_rates.csv")

# next step is to merge this dataset with the cleaned relative risks dataset, which will happen in the "calc_mortality_rates.Rmd" file


```

