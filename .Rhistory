library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)
# load and document (for automatic rendering of the roxygen comments into a man file) to keep things updated
devtools::load_all()
devtools::document()
# custom operators
`%notin%` <- Negate(`%in%`)
# global parameters
gbd_year <- 2019
#> reading in the raw .csv file for mortality rates dataset from GBD for the year mentioned uptop in the "lib_glob_parameters" code chunk
mr_dataset_2019_raw <- read_csv("./data/raw/ihme_gbd_2019_mortality_rates_by_cause.csv")
#> drop certain columns and rename others to make them more intuitive
# rename "cause_name" and "val" columns, arrange by (cause, age_id) and keep the following columns: age_id, age_name, cause_name, val.
mr_dataset_2019 <- mr_dataset_2019_raw %>%
dplyr::rename(cause = cause_name,
mortal_rate = val,
sex = sex_name) %>%
select(age_id, age_name, cause, mortal_rate) %>%
arrange(cause, age_id)
#> Replace `age_name` column's following age_names with the specified counterparts: "<1" (age_id: 235) with "0-1"
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(age_name = str_replace(age_name,  "<1 year", "0-1")) %>%
arrange(cause)
#> remove the "years" keyword from the age_name column and "+" from "95+"
mr_dataset_2019$age_name <- str_replace(mr_dataset_2019$age_name, "years", "")
#> Add an `age_interval_lower` and age_interval upper column, which would be the lower limit and upper limit of the `age_name` column and remove the "+" sign from the "age_name" column
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(age_name_ll = ifelse(str_detect(age_name, "\\+") == TRUE, str_replace(age_name, "\\+", "") , str_extract(age_name, "(.)+(-)")),
age_name_ll = str_replace(age_name_ll, "(\\+)|(-)", ""),
age_name_ul = ifelse(str_detect(age_name, "\\+") == TRUE, str_replace(age_name, "\\+", "") , str_extract(age_name, "(-)(.)+")),
age_name_ul = str_replace(age_name_ul, "(\\+)|(-)", ""))
#> renaming columns so that we are consistent with the "relative risks" dataset column names. Ultimately th "relative risks" data will be merged with the "mortality rates" dataset. Consistent column names will make the merging code more intuitive. Also, dropping the "age_id" column which is standalone column in the mortality rates datset and does not have a counterpart in the relative risks dataset (so basically is of no use to us).
mr_dataset_2019 <- mr_dataset_2019 %>%
rename(mortality_rate = mortal_rate,
age_interval_ll = age_name_ll,
age_interval_ul = age_name_ul,
age_interval = age_name) %>%
select(-c(age_id))
knitr::opts_chunk$set(echo = TRUE)
# libraries
library(readr)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)
# load and document (for automatic rendering of the roxygen comments into a man file) to keep things updated
devtools::load_all()
devtools::document()
# custom operators
`%notin%` <- Negate(`%in%`)
# global parameters
gbd_year <- 2019
#> reading in the raw .csv file for mortality rates dataset from GBD for the year mentioned uptop in the "lib_glob_parameters" code chunk
mr_dataset_2019_raw <- read_csv("./data/raw/ihme_gbd_2019_mortality_rates_by_cause.csv")
#> drop certain columns and rename others to make them more intuitive
# rename "cause_name" and "val" columns, arrange by (cause, age_id) and keep the following columns: age_id, age_name, cause_name, val.
mr_dataset_2019 <- mr_dataset_2019_raw %>%
dplyr::rename(cause = cause_name,
mortal_rate = val,
sex = sex_name) %>%
select(age_id, age_name, cause, mortal_rate) %>%
arrange(cause, age_id)
#> Replace `age_name` column's following age_names with the specified counterparts: "<1" (age_id: 235) with "0-1"
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(age_name = str_replace(age_name,  "<1 year", "0-1")) %>%
arrange(cause)
#> remove the "years" keyword from the age_name column and "+" from "95+"
mr_dataset_2019$age_name <- str_replace(mr_dataset_2019$age_name, "years", "")
#> Add an `age_interval_lower` and age_interval upper column, which would be the lower limit and upper limit of the `age_name` column and remove the "+" sign from the "age_name" column
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(age_name_ll = ifelse(str_detect(age_name, "\\+") == TRUE, str_replace(age_name, "\\+", "") , str_extract(age_name, "(.)+(-)")),
age_name_ll = str_replace(age_name_ll, "(\\+)|(-)", ""),
age_name_ul = ifelse(str_detect(age_name, "\\+") == TRUE, str_replace(age_name, "\\+", "") , str_extract(age_name, "(-)(.)+")),
age_name_ul = str_replace(age_name_ul, "(\\+)|(-)", ""))
#> renaming columns so that we are consistent with the "relative risks" dataset column names. Ultimately th "relative risks" data will be merged with the "mortality rates" dataset. Consistent column names will make the merging code more intuitive. Also, dropping the "age_id" column which is standalone column in the mortality rates datset and does not have a counterpart in the relative risks dataset (so basically is of no use to us).
mr_dataset_2019 <- mr_dataset_2019 %>%
dplyr::rename(mortality_rate = mortal_rate,
age_interval_ll = age_name_ll,
age_interval_ul = age_name_ul,
age_interval = age_name) %>%
select(-c(age_id))
#> encode the "cause" column for consistency, i.e. create a new column called "cause_id" that will map
#> each "cause_name" to a corresponding identifier number. Use the same encoding in the relative rates cleaning file.
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(cause_id = ifelse(cause == "Lower respiratory infections", 322, cause),
cause_id = ifelse(cause == "Tracheal, bronchus, and lung cancer", 426,  cause_id),
cause_id = ifelse(cause == "Ischemic heart disease", 493, cause_id),
cause_id = ifelse(cause == "Stroke", 494, cause_id),
cause_id = ifelse(cause == "Chronic obstructive pulmonary disease", 509, cause_id),
cause_id = ifelse(cause == "Diabetes mellitus type 2", 587, cause_id),
cause_id = ifelse(cause == "All causes", 294, cause_id))
#> coerce certain numeric columns into class "numeric"
mr_dataset_2019$mortality_rate <- as.numeric(mr_dataset_2019$mortality_rate)
mr_dataset_2019$age_interval_ll <- as.numeric(mr_dataset_2019$age_interval_ll)
mr_dataset_2019$age_interval_ul <- as.numeric(mr_dataset_2019$age_interval_ul)
mr_dataset_2019$cause_id <- as.numeric(mr_dataset_2019$cause_id)
#> Add an age_gap column, adjusting "0-1" and "95+" separately
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(age_gap = (age_interval_ul - age_interval_ll) + 1,
age_gap = ifelse(str_detect(age_interval, "0-1"), 1, age_gap),
age_gap = ifelse(str_detect(age_interval, "95+"), NA, age_gap))
#> Add an age_category column that maps age categories (starting from "0-1") to numbers. So, "0-1" will be mapped to 1, "1-4" will be mapped to 2, and so on.
# create a age_category to number mapping dataset
age_interval_cat_tibble <- tibble(age_interval = unique(mr_dataset_2019$age_interval))
age_interval_cat_tibble <- age_interval_cat_tibble %>%
arrange(age_interval) %>%
mutate(age_interval_category = row_number())
knitr::opts_chunk$set(echo = TRUE)
# libraries
library(readr)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)
# load and document (for automatic rendering of the roxygen comments into a man file) to keep things updated
devtools::load_all()
devtools::document()
# custom operators
`%notin%` <- Negate(`%in%`)
# global parameters
gbd_year <- 2019
#> reading in the raw .csv file for mortality rates dataset from GBD for the year mentioned uptop in the "lib_glob_parameters" code chunk
mr_dataset_2019_raw <- read_csv("./data/raw/ihme_gbd_2019_mortality_rates_by_cause.csv")
#> drop certain columns and rename others to make them more intuitive
# rename "cause_name" and "val" columns, arrange by (cause, age_id) and keep the following columns: age_id, age_name, cause_name, val.
mr_dataset_2019 <- mr_dataset_2019_raw %>%
dplyr::rename(cause = cause_name,
mortal_rate = val,
sex = sex_name) %>%
select(age_id, age_name, cause, mortal_rate) %>%
arrange(cause, age_id)
#> Replace `age_name` column's following age_names with the specified counterparts: "<1" (age_id: 235) with "0-1"
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(age_name = str_replace(age_name,  "<1 year", "0-1")) %>%
arrange(cause)
#> remove the "years" keyword from the age_name column and "+" from "95+"
mr_dataset_2019$age_name <- str_replace(mr_dataset_2019$age_name, "years", "")
#> Add an `age_interval_lower` and age_interval upper column, which would be the lower limit and upper limit of the `age_name` column and remove the "+" sign from the "age_name" column
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(age_name_ll = ifelse(str_detect(age_name, "\\+") == TRUE, str_replace(age_name, "\\+", "") , str_extract(age_name, "(.)+(-)")),
age_name_ll = str_replace(age_name_ll, "(\\+)|(-)", ""),
age_name_ul = ifelse(str_detect(age_name, "\\+") == TRUE, str_replace(age_name, "\\+", "") , str_extract(age_name, "(-)(.)+")),
age_name_ul = str_replace(age_name_ul, "(\\+)|(-)", ""))
#> renaming columns so that we are consistent with the "relative risks" dataset column names. Ultimately th "relative risks" data will be merged with the "mortality rates" dataset. Consistent column names will make the merging code more intuitive. Also, dropping the "age_id" column which is standalone column in the mortality rates datset and does not have a counterpart in the relative risks dataset (so basically is of no use to us).
mr_dataset_2019 <- mr_dataset_2019 %>%
dplyr::rename(mortality_rate = mortal_rate,
age_interval_ll = age_name_ll,
age_interval_ul = age_name_ul,
age_interval = age_name) %>%
select(-c(age_id))
#> encode the "cause" column for consistency, i.e. create a new column called "cause_id" that will map
#> each "cause_name" to a corresponding identifier number. Use the same encoding in the relative rates cleaning file.
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(cause_id = ifelse(cause == "Lower respiratory infections", 322, cause),
cause_id = ifelse(cause == "Tracheal, bronchus, and lung cancer", 426,  cause_id),
cause_id = ifelse(cause == "Ischemic heart disease", 493, cause_id),
cause_id = ifelse(cause == "Stroke", 494, cause_id),
cause_id = ifelse(cause == "Chronic obstructive pulmonary disease", 509, cause_id),
cause_id = ifelse(cause == "Diabetes mellitus type 2", 587, cause_id),
cause_id = ifelse(cause == "All causes", 294, cause_id))
#> coerce certain numeric columns into class "numeric"
mr_dataset_2019$mortality_rate <- as.numeric(mr_dataset_2019$mortality_rate)
mr_dataset_2019$age_interval_ll <- as.numeric(mr_dataset_2019$age_interval_ll)
mr_dataset_2019$age_interval_ul <- as.numeric(mr_dataset_2019$age_interval_ul)
mr_dataset_2019$cause_id <- as.numeric(mr_dataset_2019$cause_id)
#> Add an age_gap column, adjusting "0-1" and "95+" separately
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(age_gap = (age_interval_ul - age_interval_ll) + 1,
age_gap = ifelse(str_detect(age_interval, "0-1"), 1, age_gap),
age_gap = ifelse(str_detect(age_interval, "95+"), NA, age_gap))
#> Add an age_category column that maps age categories (starting from "0-1") to numbers. So, "0-1" will be mapped to 1, "1-4" will be mapped to 2, and so on.
# create a age_category to number mapping dataset
age_interval_cat_tibble <- tibble(age_interval = unique(mr_dataset_2019$age_interval))
age_interval_cat_tibble <- age_interval_cat_tibble %>%
dplyr::arrange(age_interval) %>%
dplyr::mutate(age_interval_category = row_number())
# add an "age_interval_category" column to mr_dataset_2019, by joining it with age_interval_cat_tibble, using "age_interval" as the joining column.
mr_dataset_2019 <- mr_dataset_2019 %>%
left_join(age_interval_cat_tibble, by = "age_interval")
#> make "cause" the first column and sort the mortality rates by cause, age_interval
mr_dataset_2019 <- mr_dataset_2019 %>%
select(cause, everything()) %>%
arrange(cause, age_interval)
#> separately save only the "All causes" rows in a separate dataset. This will be used later on in the Lifetable Method
mr_dataset_2019_all_causes <- mr_dataset_2019 %>%
filter(cause == "All causes")
#> Writing the cleaned GBD mortality rates (removing the "All causes" rows) file to the data/intermediate folder
mr_dataset_2019 %>%
filter(cause %notin% c("All causes")) %>%
write_csv("data/intermediate/cleaned_gbd_mortality_rates.csv")
#> Write the cleaned "All cause" rows subset data to the Intermediate folder
mr_dataset_2019_all_causes %>%
write_csv("data/intermediate/cleaned_gbd_mortality_rates_all_causes_only.csv")
# next step is to merge this dataset with the cleaned relative risks dataset, which will happen in the "calc_mortality_rates.Rmd" file
knitr::opts_chunk$set(echo = TRUE)
# libraries
library(readr)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)
library(readxl)
library(plyr)
# load and document (for automatic rendering of the roxygen comments into a man file) to keep things updated
devtools::load_all()
devtools::document()
# custom operators
`%notin%` <- Negate(`%in%`)
# global parameters
gbd_year <- 2019
#> Read in the cleaned GBD mortality rates file (note that this does not contain the "All causes" data, that is separately downloaded below)
cleaned_gbd_mortality_rates <- read_csv("./data/intermediate/cleaned_gbd_mortality_rates.csv")
#> Read in the cleaned relative risks file
cleaned_relative_risks <- read_csv("./data/intermediate/cleaned_relative_risks.csv")
#> Read in "All causes" cleaned GBD mortality rates data
cleaned_gbd_mortality_rates_all_causes_only <- read_csv("./data/intermediate/cleaned_gbd_mortality_rates_all_causes_only.csv")
#> join the cleaned mortality and relative risks datasets
cleaned_joined_mort_rr_data <- cleaned_gbd_mortality_rates %>%
left_join(cleaned_relative_risks, by = c("cause", "age_interval"))
#> dropping redundant columns and renaming certain columns after dropping the redundancies, then reordering the columns. Note that, it is possible that some of the function names for dplyr and plyr might clash. So, use the package prefix, before the function name. For example, to rename a column, use: dplyr::rename(), instead of just rename()
cleaned_joined_mort_rr_data <- cleaned_joined_mort_rr_data %>%
dplyr::select(-c(age_interval_ll.y, age_interval_ul.y, cause_id.y)) %>%
dplyr::rename(age_interval_ll = age_interval_ll.x,
age_interval_ul = age_interval_ul.x,
cause_id = cause_id.x) %>%
dplyr::arrange(cause, age_interval)
#> converting the above dataset back into long format, such that "pm_level" and "relative risk" are columns in the new dataset and sort the dataset by cause, pm_level, age_interval
cleaned_joined_mort_rr_data_long <- cleaned_joined_mort_rr_data %>%
pivot_longer(cols = relative_risk_pm0:relative_risk_pm90, names_to = c("pm_level"), names_pattern = "(\\d+)", values_to = "relative_risk") %>%
arrange(cause, pm_level, age_interval)
#> For all age groups less than 25 years of age, relative risks information is not availbale. For these, assume that relative risks = 1. Also replace any missing relative risks information with 1. Below code, replaces all those rows in the "relative_risk" column, where age_interval_ul < 25, with 1. Also, if relative risks data is missing, fill it in with relative risks = 1.
cleaned_joined_mort_rr_data_long <- cleaned_joined_mort_rr_data_long %>%
mutate(relative_risk = ifelse(age_interval_ul < 25, 1, relative_risk),
relative_risk = ifelse(is.na(relative_risk) == TRUE, 1, relative_risk))
unique(cleaned_joined_mort_rr_data_long$pm_level)
unique(cleaned_joined_mort_rr_data_long$mortality_rate)
unique(cleaned_joined_mort_rr_data_long$age_interval_ll)
knitr::opts_chunk$set(echo = TRUE)
# libraries
library(readr)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)
library(readxl)
# load and document (for automatic rendering of the roxygen comments into a man file) to keep things updated
devtools::load_all()
devtools::document()
# custom operators
`%notin%` <- Negate(`%in%`)
# global parameters
gbd_year <- 2019
#> reading in the raw .xlsx file for relative risks dataset from GBD for the year mentioned up top in the "lib_glob_parameters" code chunk
rr_dataset_2019_raw <- readxl::read_xlsx("./data/raw/ihme_gbd_2019_relative_risks_by_cause.xlsx")
#> creating a copy of the raw dataset and then using that for all analysis
rr_dataset_2019 <- rr_dataset_2019_raw
#> adding some basic structure to the raw data file such that we can clearly recognize the column names before we start cleaning. In doing so, remove the unnecessary descritive information from the file and only keep the information that is relevant for analysis.
# assign column names, which as of now are present in different rows (because the raw file was formatted this way).
colnames(rr_dataset_2019)[1:4] <- rr_dataset_2019[1, 1:4]
colnames(rr_dataset_2019)[5:ncol(rr_dataset_2019)] <- rr_dataset_2019[2, 5:ncol(rr_dataset_2019)]
# getting rid of first and second row of the dataset because they contain "column name" information, which has already been placed in its proper place in the step above.
rr_dataset_2019 <- rr_dataset_2019[4:nrow(rr_dataset_2019), ]
# rename certain columns (just removing spaces in between and converting to snake case)
colnames(rr_dataset_2019)[1] <- "cause" # "Risk/Outcome" column renamed to "Cause"
colnames(rr_dataset_2019)[2] <- "pm_level"
colnames(rr_dataset_2019)[3] <- "mortality_morbidity"
colnames(rr_dataset_2019)[4] <- "sex"
colnames(rr_dataset_2019)[5] <- "all_ages"
# removing the word "years" from the "ages" column names and also remove  any "+" signs in age columns (e.g. "95+")
age_name_column_names_vec <- colnames(rr_dataset_2019)[str_detect(colnames(rr_dataset_2019), "years")]
age_name_column_names_vec_years_removed <- str_replace(age_name_column_names_vec, "years", "")
# age_name_column_names_vec_years_removed <- str_replace(age_name_column_names_vec_years_removed, "\\+", "")
# rename "ages" column using the new "years removed age column names"
colnames(rr_dataset_2019)[str_detect(colnames(rr_dataset_2019), "years")] <- age_name_column_names_vec_years_removed
# remove the "µg/m³" sign from the pm_level column
rr_dataset_2019[, "pm_level"] <- str_remove(as.vector(unlist(rr_dataset_2019[, "pm_level"])), "µg/m³")
# keep only the relative risks numbers and remove all confidence interval information from all columns. For example: if we have this: "2.345 (1.234 to 3.232)", after cleaning we should be left with "2.345".
rr_dataset_2019[, 5:ncol(rr_dataset_2019)] <- map_dfc(rr_dataset_2019[, 5:ncol(rr_dataset_2019)], function(x){as.numeric(str_replace(x, "\\(.+\\)$", ""))})
# dropping certain unnecessary identifier columns: "mortality_morbidity" (whose value = 'both' for all rows), "sex" (whose value = 'both' for all rows)
rr_dataset_2019 <- rr_dataset_2019 %>%
select(-c(mortality_morbidity, sex))
#> impute relative risk values for all age categories of the following causes: "Lower Respiratory Infections", "Tracheal, Bronchus and lung cancer", "Chronic Obstructive Pulmonary Disease", "Diabetes mellitus type 2" by using the "all_ages" column relative risks. The assumption is that relative risks for these diseases do not vary by age, so the imputation simply copies the "all_ages" column number for a given cause "x" (the ones listed in this paragraph) into all other age categories for cause "x". Need to check if this assumption is actually backed by solid research.
#> Note that it is possible that in the coming years, age wise relative risks data starts to become available for the above 4 causes. This is why the vector named "age_wise_rr_data_not_available" below may change (and has to be accordingly updated) from one year to the next. Please make sure to do so before running the code.
age_wise_rr_data_available <- c("Ischaemic heart disease", "Stroke")
# list of all "unique" causes in the relative risks data
all_causes_list <- unique(rr_dataset_2019$cause)
# Please double check this for the latest dataset in question. This specifically refers to the number of the column from where the age categories start. In the current dataset, the first age category (i.e. 25-29) is the fourth column, which is why as of now it equates to 4.
age_categories_col_start_number <- 4
# This loop goes through the relative risks dataset row by row and if a cause is NOT in "age_wise_rr_data_available" list of causes, it copies the "all_ages" value into all other age category columns. This is following from the imputation assumption explained above.
for(i in 1:nrow(rr_dataset_2019)){
if(rr_dataset_2019$cause[i] %in% age_wise_rr_data_available){
next
} else {
rr_dataset_2019[i, age_categories_col_start_number:ncol(rr_dataset_2019)] <- as.numeric(rr_dataset_2019[i, "all_ages"])
}
}
#> now we don't need the "all_ages" column so I am dropping it
rr_dataset_2019 <- rr_dataset_2019 %>%
select(-c(all_ages))
#> reshaping the above dataset to a long format, so that age category becomes a single column. Note: there is an additional space in each of the age cateogry column names. For example: the column name "25-29" is actually "25-29 ".
rr_dataset_2019_long <- rr_dataset_2019 %>%
pivot_longer(cols = `25-29 `:`95+ `, names_to = "age_interval", values_to = "relative_risk")
#> add an age_interval_lower column to the relative risks dataset
rr_dataset_2019_long <- rr_dataset_2019_long %>%
mutate(age_interval_ll = str_extract(age_interval, "(.+)-"),
age_interval_ll = str_extract(age_interval_ll, "[^-]+"),
age_interval_ul = str_extract(age_interval, "-(.+)"),
age_interval_ul = str_extract(age_interval_ul, "[^-]+"),
age_interval_ll = ifelse(str_detect(age_interval, "95"), 95, age_interval_ll),
age_interval_ul = ifelse(str_detect(age_interval, "95"), 95, age_interval_ul))
#> encode the "cause" column for consistency, i.e. create a new column called "cause_id" that will map
#> each "cause_name" to a corresponding identifier number. Use the same encoding in the mortality rates cleaning file.
rr_dataset_2019_long <- rr_dataset_2019_long %>%
mutate(cause_id = ifelse(cause == "Lower respiratory infections", 322, cause),
cause_id = ifelse(cause == "Tracheal, bronchus, and lung cancer", 426,  cause_id),
cause_id = ifelse(cause == "Ischemic heart disease", 493, cause_id),
cause_id = ifelse(cause == "Stroke", 494, cause_id),
cause_id = ifelse(cause == "Chronic obstructive pulmonary disease", 509, cause_id),
cause_id = ifelse(cause == "Diabetes mellitus type 2", 587, cause_id))
#> sorting the dataset by cause, age_interval, pm_level columns
rr_dataset_2019_long <- rr_dataset_2019_long %>%
arrange(cause, age_interval, pm_level)
#> coercing certain numeric columns to class "numeric"
rr_dataset_2019_long$pm_level <- as.numeric(rr_dataset_2019_long$pm_level)
rr_dataset_2019_long$relative_risk <- as.numeric(rr_dataset_2019_long$relative_risk)
rr_dataset_2019_long$age_interval_ll <- as.numeric(rr_dataset_2019_long$age_interval_ll)
rr_dataset_2019_long$age_interval_ul <- as.numeric(rr_dataset_2019_long$age_interval_ul)
rr_dataset_2019_long$cause_id <- as.numeric(rr_dataset_2019_long$cause_id)
#> reshaping the relative risks data back to wide, moving the pm level wise relative risks in the columns, so that the [cause, age_interval] combination can become a unique identifier. This way, we can easily merge the relative risks dataset with the mortality rates dataset.
rr_dataset_2019_wide_final <- rr_dataset_2019_long %>%
pivot_wider(names_from = "pm_level", names_prefix = "relative_risk_pm", values_from = "relative_risk")
#> writing the cleaned relative risks file to the data/intermediate folder
rr_dataset_2019_wide_final %>%
write_csv("./data/intermediate/cleaned_relative_risks.csv")
# next step is to merge this dataset with the cleaned mortality rates dataset, which will happen in the "calc_mortality_rates.Rmd" file
knitr::opts_chunk$set(echo = TRUE)
# libraries
library(readr)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)
# load and document (for automatic rendering of the roxygen comments into a man file) to keep things updated
devtools::load_all()
devtools::document()
# custom operators
`%notin%` <- Negate(`%in%`)
# global parameters
gbd_year <- 2019
#> reading in the raw .csv file for mortality rates dataset from GBD for the year mentioned uptop in the "lib_glob_parameters" code chunk
mr_dataset_2019_raw <- read_csv("./data/raw/ihme_gbd_2019_mortality_rates_by_cause.csv")
#> drop certain columns and rename others to make them more intuitive
# rename "cause_name" and "val" columns, arrange by (cause, age_id) and keep the following columns: age_id, age_name, cause_name, val.
mr_dataset_2019 <- mr_dataset_2019_raw %>%
dplyr::rename(cause = cause_name,
mortal_rate = val,
sex = sex_name) %>%
select(age_id, age_name, cause, mortal_rate) %>%
arrange(cause, age_id)
#> Replace `age_name` column's following age_names with the specified counterparts: "<1" (age_id: 235) with "0-1"
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(age_name = str_replace(age_name,  "<1 year", "0-1")) %>%
arrange(cause)
#> remove the "years" keyword from the age_name column and "+" from "95+"
mr_dataset_2019$age_name <- str_replace(mr_dataset_2019$age_name, "years", "")
#> Add an `age_interval_lower` and age_interval upper column, which would be the lower limit and upper limit of the `age_name` column and remove the "+" sign from the "age_name" column
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(age_name_ll = ifelse(str_detect(age_name, "\\+") == TRUE, str_replace(age_name, "\\+", "") , str_extract(age_name, "(.)+(-)")),
age_name_ll = str_replace(age_name_ll, "(\\+)|(-)", ""),
age_name_ul = ifelse(str_detect(age_name, "\\+") == TRUE, str_replace(age_name, "\\+", "") , str_extract(age_name, "(-)(.)+")),
age_name_ul = str_replace(age_name_ul, "(\\+)|(-)", ""))
#> renaming columns so that we are consistent with the "relative risks" dataset column names. Ultimately th "relative risks" data will be merged with the "mortality rates" dataset. Consistent column names will make the merging code more intuitive. Also, dropping the "age_id" column which is standalone column in the mortality rates datset and does not have a counterpart in the relative risks dataset (so basically is of no use to us).
mr_dataset_2019 <- mr_dataset_2019 %>%
dplyr::rename(mortality_rate = mortal_rate,
age_interval_ll = age_name_ll,
age_interval_ul = age_name_ul,
age_interval = age_name) %>%
select(-c(age_id))
#> encode the "cause" column for consistency, i.e. create a new column called "cause_id" that will map
#> each "cause_name" to a corresponding identifier number. Use the same encoding in the relative rates cleaning file.
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(cause_id = ifelse(cause == "Lower respiratory infections", 322, cause),
cause_id = ifelse(cause == "Tracheal, bronchus, and lung cancer", 426,  cause_id),
cause_id = ifelse(cause == "Ischemic heart disease", 493, cause_id),
cause_id = ifelse(cause == "Stroke", 494, cause_id),
cause_id = ifelse(cause == "Chronic obstructive pulmonary disease", 509, cause_id),
cause_id = ifelse(cause == "Diabetes mellitus type 2", 587, cause_id),
cause_id = ifelse(cause == "All causes", 294, cause_id))
#> coerce certain numeric columns into class "numeric"
mr_dataset_2019$mortality_rate <- as.numeric(mr_dataset_2019$mortality_rate)
mr_dataset_2019$age_interval_ll <- as.numeric(mr_dataset_2019$age_interval_ll)
mr_dataset_2019$age_interval_ul <- as.numeric(mr_dataset_2019$age_interval_ul)
mr_dataset_2019$cause_id <- as.numeric(mr_dataset_2019$cause_id)
#> Add an age_gap column, adjusting "0-1" and "95+" separately
mr_dataset_2019 <- mr_dataset_2019 %>%
mutate(age_gap = (age_interval_ul - age_interval_ll) + 1,
age_gap = ifelse(str_detect(age_interval, "0-1"), 1, age_gap),
age_gap = ifelse(str_detect(age_interval, "95+"), NA, age_gap))
#> Add an age_category column that maps age categories (starting from "0-1") to numbers. So, "0-1" will be mapped to 1, "1-4" will be mapped to 2, and so on.
# create a age_category to number mapping dataset
age_interval_cat_tibble <- tibble(age_interval = unique(mr_dataset_2019$age_interval))
age_interval_cat_tibble <- age_interval_cat_tibble %>%
dplyr::arrange(age_interval) %>%
dplyr::mutate(age_interval_category = row_number())
# add an "age_interval_category" column to mr_dataset_2019, by joining it with age_interval_cat_tibble, using "age_interval" as the joining column.
mr_dataset_2019 <- mr_dataset_2019 %>%
left_join(age_interval_cat_tibble, by = "age_interval")
#> make "cause" the first column and sort the mortality rates by cause, age_interval
mr_dataset_2019 <- mr_dataset_2019 %>%
select(cause, everything()) %>%
arrange(cause, age_interval)
#> separately save only the "All causes" rows in a separate dataset. This will be used later on in the Lifetable Method
mr_dataset_2019_all_causes <- mr_dataset_2019 %>%
filter(cause == "All causes")
#> Writing the cleaned GBD mortality rates (removing the "All causes" rows) file to the data/intermediate folder
mr_dataset_2019 %>%
filter(cause %notin% c("All causes")) %>%
write_csv("data/intermediate/cleaned_gbd_mortality_rates.csv")
#> Write the cleaned "All cause" rows subset data to the Intermediate folder
mr_dataset_2019_all_causes %>%
write_csv("data/intermediate/cleaned_gbd_mortality_rates_all_causes_only.csv")
# next step is to merge this dataset with the cleaned relative risks dataset, which will happen in the "calc_mortality_rates.Rmd" file
knitr::opts_chunk$set(echo = TRUE)
# libraries
library(readr)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)
library(readxl)
library(plyr)
# load and document (for automatic rendering of the roxygen comments into a man file) to keep things updated
devtools::load_all()
devtools::document()
# custom operators
`%notin%` <- Negate(`%in%`)
# global parameters
gbd_year <- 2019
#> Read in the cleaned GBD mortality rates file (note that this does not contain the "All causes" data, that is separately downloaded below)
cleaned_gbd_mortality_rates <- read_csv("./data/intermediate/cleaned_gbd_mortality_rates.csv")
#> Read in the cleaned relative risks file
cleaned_relative_risks <- read_csv("./data/intermediate/cleaned_relative_risks.csv")
#> Read in "All causes" cleaned GBD mortality rates data
cleaned_gbd_mortality_rates_all_causes_only <- read_csv("./data/intermediate/cleaned_gbd_mortality_rates_all_causes_only.csv")
#> join the cleaned mortality and relative risks datasets
cleaned_joined_mort_rr_data <- cleaned_gbd_mortality_rates %>%
left_join(cleaned_relative_risks, by = c("cause", "age_interval"))
#> dropping redundant columns and renaming certain columns after dropping the redundancies, then reordering the columns. Note that, it is possible that some of the function names for dplyr and plyr might clash. So, use the package prefix, before the function name. For example, to rename a column, use: dplyr::rename(), instead of just rename()
cleaned_joined_mort_rr_data <- cleaned_joined_mort_rr_data %>%
dplyr::select(-c(age_interval_ll.y, age_interval_ul.y, cause_id.y)) %>%
dplyr::rename(age_interval_ll = age_interval_ll.x,
age_interval_ul = age_interval_ul.x,
cause_id = cause_id.x) %>%
dplyr::arrange(cause, age_interval)
#> converting the above dataset back into long format, such that "pm_level" and "relative risk" are columns in the new dataset and sort the dataset by cause, pm_level, age_interval
cleaned_joined_mort_rr_data_long <- cleaned_joined_mort_rr_data %>%
pivot_longer(cols = relative_risk_pm0:relative_risk_pm90, names_to = c("pm_level"), names_pattern = "(\\d+)", values_to = "relative_risk") %>%
arrange(cause, pm_level, age_interval)
#> For all age groups less than 25 years of age, relative risks information is not availbale. For these, assume that relative risks = 1. Also replace any missing relative risks information with 1. Below code, replaces all those rows in the "relative_risk" column, where age_interval_ul < 25, with 1. Also, if relative risks data is missing, fill it in with relative risks = 1.
cleaned_joined_mort_rr_data_long <- cleaned_joined_mort_rr_data_long %>%
mutate(relative_risk = ifelse(age_interval_ul < 25, 1, relative_risk),
relative_risk = ifelse(is.na(relative_risk) == TRUE, 1, relative_risk))
#> coercing numeric columns to type "numeric"
cleaned_joined_mort_rr_data_long$mortality_rate <-
View(cleaned_joined_mort_rr_data_long)
